<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>helgoland-toolbox documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">helgoland-toolbox documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li>FacetSearchConfig</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>projects/helgoland/facet-search/src/lib/facet-search.service.ts</code>
        </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Optional</span>
                                <a href="#showZeroValues">showZeroValues</a>
                            </li>
                        </ul>
                    </td>
                </tr>






        </tbody>
    </table>
</section>



            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="showZeroValues"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Optional</span>
                            showZeroValues</b>
                            <a href="#showZeroValues"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="23" class="link-to-prism">projects/helgoland/facet-search/src/lib/facet-search.service.ts:23</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, Optional } from &#x27;@angular/core&#x27;;
import { HelgolandTimeseries, Timespan } from &#x27;@helgoland/core&#x27;;
import { Observable, ReplaySubject } from &#x27;rxjs&#x27;;

import { FacetParameter, ParameterFacetSort, ParameterFacetType } from &#x27;./facet-search-model&#x27;;

export abstract class FacetSearchService {
  abstract getResults(): Observable&lt;HelgolandTimeseries[]&gt;;
  abstract getParameterList(type: ParameterFacetType, sort: ParameterFacetSort): FacetParameter[];
  abstract selectParameter(type: ParameterFacetType, parameter: FacetParameter): any;
  abstract setTimeseries(timeseries: HelgolandTimeseries[]);
  abstract getFilteredResults(): HelgolandTimeseries[];
  abstract setSelectedTimespan(timespan: Timespan);
  abstract getSelectedTimespan(): Timespan;
  abstract getFilteredTimespan(): Timespan;
  abstract getCompleteTimespan(): Timespan;
  abstract resetAllFacets();
  abstract areFacetsSelected(): boolean;
}

@Injectable()
export class FacetSearchConfig {
  showZeroValues?: boolean;
}

@Injectable()
export class FacetSearchServiceImpl implements FacetSearchService {

  private onResultsChanged: ReplaySubject&lt;HelgolandTimeseries[]&gt; &#x3D; new ReplaySubject(1);

  private facets: Map&lt;ParameterFacetType, FacetParameter&gt; &#x3D; new Map();

  private timeseries: HelgolandTimeseries[];

  private selectedTimespan: Timespan;

  private filteredTimeseries: HelgolandTimeseries[];

  private nullable &#x3D; false;

  constructor(
    @Optional() config?: FacetSearchConfig
  ) {
    if (config &amp;&amp; config.showZeroValues) { this.nullable &#x3D; config.showZeroValues; }
  }

  public setTimeseries(ts: HelgolandTimeseries[]) {
    this.timeseries &#x3D; ts;
    this.setFilteredTimeseries();
  }

  public getResults(): Observable&lt;HelgolandTimeseries[]&gt; {
    return this.onResultsChanged.asObservable();
  }

  public getParameterList(type: ParameterFacetType, sort: ParameterFacetSort): FacetParameter[] {
    let params &#x3D; [];
    if (this.filteredTimeseries) {
      switch (type) {
        case ParameterFacetType.category:
          if (this.nullable) { params &#x3D; this.createEmptyParamList(ParameterFacetType.category); }
          this.filteredTimeseries.forEach(e &#x3D;&gt; this.addParameter(params, ParameterFacetType.category, e.parameters.category.label));
          break;
        case ParameterFacetType.feature:
          if (this.nullable) { params &#x3D; this.createEmptyParamList(ParameterFacetType.feature); }
          this.filteredTimeseries.forEach(e &#x3D;&gt; this.addParameter(params, ParameterFacetType.feature, e.parameters.feature.label));
          break;
        case ParameterFacetType.offering:
          if (this.nullable) { params &#x3D; this.createEmptyParamList(ParameterFacetType.offering); }
          this.filteredTimeseries.forEach(e &#x3D;&gt; this.addParameter(params, ParameterFacetType.offering, e.parameters.offering.label));
          break;
        case ParameterFacetType.phenomenon:
          if (this.nullable) { params &#x3D; this.createEmptyParamList(ParameterFacetType.phenomenon); }
          this.filteredTimeseries.forEach(e &#x3D;&gt; this.addParameter(params, ParameterFacetType.phenomenon, e.parameters.phenomenon.label));
          break;
        case ParameterFacetType.procedure:
          if (this.nullable) { params &#x3D; this.createEmptyParamList(ParameterFacetType.procedure); }
          this.filteredTimeseries.forEach(e &#x3D;&gt; this.addParameter(params, ParameterFacetType.procedure, e.parameters.procedure.label));
          break;
      }
    }
    return this.sortParameters(params, sort);
  }

  public selectParameter(type: ParameterFacetType, parameter: FacetParameter) {
    if (parameter.selected) {
      this.facets.set(type, parameter);
    } else {
      this.facets.delete(type);
    }
    this.setFilteredTimeseries();
  }

  public areFacetsSelected(): boolean {
    return this.facets.size &gt; 0 || !!this.selectedTimespan;
  }

  public getFilteredResults(): HelgolandTimeseries[] {
    return this.filteredTimeseries;
  }

  public getCompleteTimespan(): Timespan {
    return this.createTimespan(this.timeseries);
  }

  public setSelectedTimespan(timespan: Timespan) {
    this.selectedTimespan &#x3D; timespan;
    this.setFilteredTimeseries();
  }

  public getSelectedTimespan(): Timespan {
    return this.selectedTimespan;
  }

  public getFilteredTimespan(): Timespan {
    return this.createTimespan(this.filteredTimeseries);
  }

  public resetAllFacets() {
    this.facets.clear();
    this.selectedTimespan &#x3D; null;
    this.setFilteredTimeseries();
  }

  private createTimespan(timeseriesList: HelgolandTimeseries[]): Timespan {
    let timespan: Timespan &#x3D; null;
    if (timeseriesList.length &gt; 0) {
      timespan &#x3D; { from: Infinity, to: 0 };
      timeseriesList.forEach(e &#x3D;&gt; {
        if (e.firstValue &amp;&amp; e.lastValue) {
          if (e.firstValue.timestamp &lt; timespan.from) { timespan.from &#x3D; e.firstValue.timestamp; }
          if (e.lastValue.timestamp &gt; timespan.to) { timespan.to &#x3D; e.lastValue.timestamp; }
        }
      });
    }
    if (timespan.from !&#x3D;&#x3D; Infinity &amp;&amp; timespan.to !&#x3D;&#x3D; 0) {
      return timespan;
    }
  }

  private setFilteredTimeseries() {
    if (this.facets.size &gt; 0 || this.selectedTimespan) {
      this.filteredTimeseries &#x3D; this.timeseries.filter(e &#x3D;&gt; {
        const matchCategory &#x3D; this.checkFacet(ParameterFacetType.category, e.parameters.category.label);
        const matchFeature &#x3D; this.checkFacet(ParameterFacetType.feature, e.parameters.feature.label);
        const matchOffering &#x3D; this.checkFacet(ParameterFacetType.offering, e.parameters.offering.label);
        const matchPhenomenon &#x3D; this.checkFacet(ParameterFacetType.phenomenon, e.parameters.phenomenon.label);
        const matchProcedure &#x3D; this.checkFacet(ParameterFacetType.procedure, e.parameters.procedure.label);
        const matchTimespan &#x3D; this.checkTimespan(e);
        return matchCategory &amp;&amp; matchFeature &amp;&amp; matchOffering &amp;&amp; matchPhenomenon &amp;&amp; matchProcedure &amp;&amp; matchTimespan;
      });
    } else {
      this.filteredTimeseries &#x3D; this.timeseries;
    }
    if (this.filteredTimeseries) {
      this.onResultsChanged.next(this.filteredTimeseries);
    }
  }

  private checkTimespan(ts: HelgolandTimeseries): boolean {
    if (this.selectedTimespan) {
      const checkfrom &#x3D; this.selectedTimespan.from &lt;&#x3D; ts.lastValue.timestamp &amp;&amp; this.selectedTimespan.to &gt;&#x3D; ts.firstValue.timestamp;
      return checkfrom;
    }
    return true;
  }

  private checkFacet(type: ParameterFacetType, parameter: string): boolean {
    if (this.facets.has(type)) {
      return parameter &#x3D;&#x3D;&#x3D; this.facets.get(type).label;
    }
    return true;
  }

  private sortParameters(list: FacetParameter[], sort: ParameterFacetSort): FacetParameter[] {
    if (sort &#x3D;&#x3D;&#x3D; null || sort &#x3D;&#x3D;&#x3D; ParameterFacetSort.none) { return list; }
    list.sort((a, b) &#x3D;&gt; {
      switch (sort) {
        case ParameterFacetSort.ascCount:
          return a.count - b.count;
        case ParameterFacetSort.descCount:
          return b.count - a.count;
        case ParameterFacetSort.ascAlphabet:
          return b.label &lt; a.label ? 1 : -1;
        case ParameterFacetSort.descAlphabet:
          return b.label &gt; a.label ? 1 : -1;
      }
    });
    return list;
  }

  private addParameter(list: FacetParameter[], type: ParameterFacetType, entry: string) {
    const existing &#x3D; list.find(e &#x3D;&gt; e.label &#x3D;&#x3D;&#x3D; entry);
    if (existing) {
      existing.count +&#x3D; 1;
    } else {
      list.push({
        label: entry,
        count: 1,
        selected: this.checkSelection(type, entry)
      });
    }
  }

  private createEmptyParamList(type: ParameterFacetType): FacetParameter[] {
    const params: FacetParameter[] &#x3D; [];
    this.timeseries.forEach(ts &#x3D;&gt; {
      if (!params.find(e &#x3D;&gt; e.label &#x3D;&#x3D;&#x3D; ts.parameters[type].label)) {
        params.push({ label: ts.parameters[type].label, count: 0, selected: this.checkSelection(type, ts.parameters[type].label) });
      }
    });
    return params;
  }

  private checkSelection(type: ParameterFacetType, entry: string): boolean {
    return this.facets.has(type) &amp;&amp; this.facets.get(type).label &#x3D;&#x3D;&#x3D; entry;
  }

}
</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'FacetSearchConfig.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
