<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>helgoland-toolbox documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">helgoland-toolbox documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>InternalWMSLayer</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>projects/helgoland/open-layers/src/lib/services/wms-capabilities.service.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#Abstract">Abstract</a>
                                </li>
                                <li>
                                        <a href="#BoundingBox">BoundingBox</a>
                                </li>
                                <li>
                                        <a href="#Dimension">Dimension</a>
                                </li>
                                <li>
                                        <a href="#EX_GeographicBoundingBox">EX_GeographicBoundingBox</a>
                                </li>
                                <li>
                                        <a href="#Layer">Layer</a>
                                </li>
                                <li>
                                        <a href="#Name">Name</a>
                                </li>
                                <li>
                                        <a href="#Style">Style</a>
                                </li>
                                <li>
                                        <a href="#Title">Title</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Abstract"></a>
                                        <span class="name"><b>Abstract</b><a href="#Abstract"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Abstract:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="BoundingBox"></a>
                                        <span class="name"><b>BoundingBox</b><a href="#BoundingBox"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>BoundingBox:     <code>literal type[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Dimension"></a>
                                        <span class="name"><b>Dimension</b><a href="#Dimension"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Dimension:     <code>literal type[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="EX_GeographicBoundingBox"></a>
                                        <span class="name"><b>EX_GeographicBoundingBox</b><a href="#EX_GeographicBoundingBox"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>EX_GeographicBoundingBox:     <code>number[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>number[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Layer"></a>
                                        <span class="name"><b>Layer</b><a href="#Layer"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Layer:     <code>InternalWMSLayer[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>InternalWMSLayer[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Name"></a>
                                        <span class="name"><b>Name</b><a href="#Name"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Name:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Style"></a>
                                        <span class="name"><b>Style</b><a href="#Style"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Style:     <code>literal type[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Title"></a>
                                        <span class="name"><b>Title</b><a href="#Title"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Title:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import { HttpService } from &#x27;@helgoland/core&#x27;;
import WMSCapabilities from &#x27;ol/format/WMSCapabilities&#x27;;
import { Observable } from &#x27;rxjs&#x27;;
import { map } from &#x27;rxjs/operators&#x27;;

interface InternalWMSLayer {
  Name: string;
  Title: string;
  Abstract: string;
  Layer: InternalWMSLayer[];
  Dimension: {
    name: string;
    default: string;
    values: string;
  }[];
  BoundingBox: {
    crs: string;
    extent: number[]
  }[];
  Style: {
    Abstract: string;
    Name: string;
    Title: string;
    LegendURL: {
      Format: string;
      OnlineResource: string;
      size: number[];
    }[]
  }[];
  EX_GeographicBoundingBox: number[];
}

export interface WMSLayer {
  name: string;
  title: string;
  abstract: string;
  childLayer: WMSLayer[];
}

// request Capabilities only all 5 minutes
const WMS_CAPABILITIES_REQUEST_EXPIRATION &#x3D; 1000 * 60 * 5;

/**
 * Handler for WMS capabilities
 */
@Injectable({
  providedIn: &#x27;root&#x27;
})
export class WmsCapabilitiesService {

  constructor(
    private http: HttpService
  ) { }

  /**
   * Returns the layer title of the capabilities as observable
   *
   * @param layerName
   * @param wmsurl
   * @returns layer title as string observable
   */
  public getTitle(layerName: string, wmsurl: string): Observable&lt;string&gt; {
    return this.getLayerInfo(layerName, wmsurl).pipe(map(layer &#x3D;&gt; layer.Title));
  }

  /**
   * Returns the layer abstract of the capabilities as observable
   *
   * @param layerName
   * @param wmsurl
   * @returns layer abstract as string observable
   */
  public getAbstract(layerName: string, wmsurl: string): Observable&lt;string&gt; {
    return this.getLayerInfo(layerName, wmsurl).pipe(map(layer &#x3D;&gt; layer.Abstract));
  }

  /**
   * Returns a date array as observable for the given layername, if available
   *
   * @param layerName
   * @param wmsurl
   * @returns
   */
  public getTimeDimensionArray(layerName: string, wmsurl: string): Observable&lt;Date[]&gt; {
    return this.getLayerInfo(layerName, wmsurl).pipe(map(layer &#x3D;&gt; {
      const timeDimension &#x3D; layer.Dimension.find(e &#x3D;&gt; e.name &#x3D; &#x27;time&#x27;);
      if (timeDimension) {
        return this.createTimeList(timeDimension);
      } else {
        return [];
      }
    }));
  }

  /**
   * Returns a legend url as observable, if available
   *
   * @param layerName
   * @param wmsurl
   * @returns
   */
  public getLegendUrl(layerName: string, wmsurl: string): Observable&lt;string&gt; {
    return this.getLayerInfo(layerName, wmsurl).pipe(map(layer &#x3D;&gt; {
      let legendUrl &#x3D; &#x27;&#x27;;
      layer.Style.forEach(s &#x3D;&gt; s.LegendURL.forEach(l &#x3D;&gt; legendUrl &#x3D; l.OnlineResource));
      return legendUrl;
    }));
  }

  /**
   * Returns the default date as observable for the given layername, if available
   *
   * @param layerName
   * @param wmsurl
   * @returns
   */
  public getDefaultTimeDimension(layerName: string, wmsurl: string): Observable&lt;Date&gt; {
    return this.getLayerInfo(layerName, wmsurl).pipe(map(layer &#x3D;&gt; {
      const timeDimension &#x3D; layer.Dimension.find(e &#x3D;&gt; e.name &#x3D; &#x27;time&#x27;);
      if (timeDimension &amp;&amp; timeDimension.default) {
        if (timeDimension.default &#x3D;&#x3D;&#x3D; &#x27;current&#x27;) {
          const timeList &#x3D; this.createTimeList(timeDimension);
          return this.findNearestTimestamp(timeList, new Date());
        } else {
          return new Date(timeDimension.default);
        }
      } else {
        return null;
      }
    }));
  }

  /**
   * Returns the extent as observable for the given layername and epsg code, if available
   *
   * @param layerName
   * @param wmsurl
   * @param epsgCode
   * @returns
   */
  public getExtent(layerName: string, wmsurl: string, epsgCode: string): Observable&lt;{ crs: string, extent: number[] }&gt; {
    return this.getLayerInfo(layerName, wmsurl).pipe(map(layer &#x3D;&gt; {
      const match &#x3D; layer.BoundingBox.find(e &#x3D;&gt; e.crs &#x3D;&#x3D;&#x3D; epsgCode);
      if (match) {
        return this.fixExtent(match.crs, match.extent);
      } else {
        if (layer.BoundingBox.length &gt; 0) {
          return this.fixExtent(layer.BoundingBox[0].crs, layer.BoundingBox[0].extent);
        }
      }
    }));
  }

  public getLayerTree(wmsurl: string): Observable&lt;WMSLayer&gt; {
    return this.getCapabilities(wmsurl).pipe(map(res &#x3D;&gt; this.createLayer(res.Capability.Layer)));
  }

  /**
   * Removes every request parameter of the url an returns this cleand url.
   */
  public cleanUpWMSUrl(url: string): string {
    let wmsRequesturl &#x3D; url;
    if (wmsRequesturl.indexOf(&#x27;?&#x27;) !&#x3D;&#x3D; -1) {
      wmsRequesturl &#x3D; wmsRequesturl.substring(0, wmsRequesturl.indexOf(&#x27;?&#x27;));
    }
    return wmsRequesturl;
  }

  private createLayer(layer: InternalWMSLayer): WMSLayer {
    return {
      name: layer.Name,
      title: layer.Title,
      abstract: layer.Abstract,
      childLayer: layer.Layer ? layer.Layer.map(l &#x3D;&gt; this.createLayer(l)) : []
    };
  }

  private getCapabilities(url: string): Observable&lt;any&gt; {
    const wmsRequesturl &#x3D; this.cleanUpWMSUrl(url) + &#x27;?request&#x3D;GetCapabilities&amp;service&#x3D;wms&amp;version&#x3D;1.3.0&#x27;;
    return this.http.client({ expirationAtMs: new Date().getTime() + WMS_CAPABILITIES_REQUEST_EXPIRATION }).get(wmsRequesturl, { responseType: &#x27;text&#x27; })
      .pipe(map(res &#x3D;&gt; new WMSCapabilities().read(res)));
  }

  private findLayerByName(name: string, layerList: InternalWMSLayer[]): InternalWMSLayer {
    let layer &#x3D; layerList.find(e &#x3D;&gt; e.Name &#x3D;&#x3D;&#x3D; name);
    if (layer) {
      return layer;
    } else {
      for (let i &#x3D; 0; i &lt; layerList.length; i++) {
        if (layerList[i].Layer) {
          layer &#x3D; this.findLayerByName(name, layerList[i].Layer);
          if (layer) {
            return layer;
          }
        }
      }
    }
  }

  private getLayerInfo(layerName, url): Observable&lt;InternalWMSLayer&gt; {
    return this.getCapabilities(url).pipe(
      map(caps &#x3D;&gt; this.findLayerByName(layerName, caps.Capability.Layer.Layer))
    );
  }

  private fixExtent(crs: string, extent: number[]): { crs: string, extent: number[] } {
    if (crs &#x3D;&#x3D;&#x3D; &#x27;EPSG:4326&#x27;) {
      const fixExtent &#x3D; [extent[1], extent[0], extent[3], extent[2]];
      return { crs, extent: fixExtent };
    } else {
      return { crs, extent };
    }
  }

  private createTimeList(timeDimension: { name: string; default: string; values: string; }): Date[] {
    return timeDimension.values.split(&#x27;,&#x27;).map(e &#x3D;&gt; new Date(e));
  }

  private findNearestTimestamp(timeList: Date[], stamp: Date): Date {
    let bestDate &#x3D; timeList.length;
    let bestDiff &#x3D; -(new Date(0, 0, 0)).valueOf();
    let currDiff &#x3D; 0;
    for (let i &#x3D; 0; i &lt; timeList.length; ++i) {
      currDiff &#x3D; Math.abs(timeList[i].valueOf() - stamp.valueOf());
      if (currDiff &lt; bestDiff) {
        bestDate &#x3D; i;
        bestDiff &#x3D; currDiff;
      }
    }
    return timeList[bestDate];
  }
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'InternalWMSLayer.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
